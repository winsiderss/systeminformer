# System Informer 프로젝트 구조설계서

## 문서 정보
- **프로젝트명**: System Informer (구 Process Hacker)
- **버전**: 3.x
- **라이선스**: MIT License
- **문서 작성일**: 2026-01-25

---

## 1. 프로젝트 개요

### 1.1 프로젝트 소개

System Informer는 Windows 운영체제를 위한 고급 시스템 모니터링 및 분석 도구입니다. 프로세스, 스레드, 핸들, 메모리, 네트워크 연결 등 시스템의 모든 측면을 심층적으로 분석할 수 있는 기능을 제공합니다.

### 1.2 주요 특징

- **다층 아키텍처**: GUI 애플리케이션, 핵심 라이브러리, 커널 드라이버의 3계층 구조
- **보안 중심 설계**: 드라이버 서명, 클라이언트 검증, 무결성 확인
- **확장 가능한 플러그인 시스템**: 기능 확장을 위한 모듈화된 플러그인 아키텍처
- **포괄적 시스템 모니터링**: 프로세스, 스레드, 핸들, 메모리, 네트워크, GPU 등
- **저수준 시스템 접근**: Native NT API 및 커널 드라이버를 통한 심층 분석

### 1.3 지원 플랫폼

| 플랫폼 | 아키텍처 | 지원 |
|--------|----------|------|
| Windows 10 | x86, x64, ARM64 | 완전 지원 |
| Windows 11 | x64, ARM64 | 완전 지원 |

> **참고**: Windows 10 이상이 공식 지원 요구 사항입니다.

---

## 2. 시스템 아키텍처

### 2.1 계층 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                     사용자 인터페이스 계층                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ SystemInformer  │  │    Plugins      │  │    PEView       │  │
│  │   (GUI App)     │  │   (Extensions)  │  │   (PE Viewer)   │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
└───────────┼────────────────────┼────────────────────┼───────────┘
            │                    │                    │
┌───────────┼────────────────────┼────────────────────┼───────────┐
│           ▼                    ▼                    ▼           │
│                      핵심 라이브러리 계층                         │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                          phlib                              ││
│  │   (프로세스/시스템 라이브러리 - 130K+ LOC)                    ││
│  └──────────────────────────┬──────────────────────────────────┘│
│                             │                                   │
│  ┌─────────────────┐  ┌─────┴─────┐  ┌─────────────────┐       │
│  │      phnt       │  │  kphlib   │  │    phsvc        │       │
│  │  (NT API 헤더)  │  │(KPH 통신) │  │   (서비스)      │       │
│  └─────────────────┘  └─────┬─────┘  └─────────────────┘       │
└─────────────────────────────┼───────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                             ▼                                   │
│                      커널 드라이버 계층                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   KSystemInformer                           ││
│  │               (WDM 커널 드라이버)                            ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐       ││
│  │  │ Informer    │ │ Protection  │ │   CID Tracking  │       ││
│  │  │ (모니터링)  │ │   (보안)    │ │   (추적)        │       ││
│  │  └─────────────┘ └─────────────┘ └─────────────────┘       ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                             ▼                                   │
│                    Windows 커널 (NT Kernel)                     │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 컴포넌트 간 통신

```
┌──────────────┐     IPC/RPC      ┌──────────────┐
│ SystemInformer│◄───────────────►│    phsvc     │
│   (Client)    │                 │  (Service)   │
└──────┬───────┘                  └──────────────┘
       │
       │ Native API (ntdll.dll)
       │
       ▼
┌──────────────┐  DeviceIoControl  ┌──────────────┐
│    phlib     │◄─────────────────►│KSystemInformer│
│  (Library)   │                   │  (Driver)    │
└──────────────┘                   └──────────────┘
```

---

## 3. 디렉토리 구조

### 3.1 루트 디렉토리

```
systeminformer/
├── SystemInformer/          # 메인 GUI 애플리케이션
├── KSystemInformer/         # 커널 드라이버
├── phlib/                   # 핵심 라이브러리
├── phnt/                    # Native NT API 헤더
├── kphlib/                  # 커널 프로토콜 라이브러리
├── plugins/                 # 플러그인 모음
├── tools/                   # 빌드 도구 및 유틸리티
├── build/                   # 빌드 스크립트
├── cmake/                   # CMake 설정
├── .github/                 # GitHub Actions CI/CD
├── .vscode/                 # VS Code 설정
├── SystemInformer.sln       # 메인 솔루션
├── KSystemInformer.sln      # 드라이버 솔루션
├── Plugins.sln              # 플러그인 솔루션
└── CMakeLists.txt           # CMake 루트 설정
```

### 3.2 SystemInformer (GUI 애플리케이션)

```
SystemInformer/
├── include/                 # 헤더 파일
│   ├── phapp.h             # 메인 애플리케이션 헤더
│   ├── phplug.h            # 플러그인 인터페이스
│   ├── mainwndp.h          # 메인 윈도우 비공개 헤더
│   └── ...
├── phsvc/                   # 서비스 컴포넌트
│   ├── svcmain.c           # 서비스 진입점
│   ├── svcclient.c         # 클라이언트
│   └── svcapi.c            # API 구현
├── resources/               # 리소스 파일
│   ├── etwguids.txt        # ETW GUID 매핑
│   ├── pooltag.txt         # 커널 풀 태그
│   └── *.png               # 아이콘 이미지
├── mainwnd.c               # 메인 윈도우
├── proctree.c              # 프로세스 트리 뷰
├── procprv.c               # 프로세스 공급자
├── actions.c               # 프로세스 작업
├── options.c               # 설정 관리
├── plugin.c                # 플러그인 로더
└── SystemInformer.vcxproj  # VS 프로젝트
```

### 3.3 KSystemInformer (커널 드라이버)

```
KSystemInformer/
├── include/                 # 드라이버 헤더
│   ├── kph.h               # 메인 헤더
│   ├── comms.h             # 통신 헤더
│   ├── informer.h          # Informer 헤더
│   └── informer_filep.h    # 파일 Informer 내부 헤더
├── informer_process.c       # 프로세스 모니터링
├── informer_thread.c        # 스레드 모니터링
├── informer_file.c          # 파일 모니터링
├── informer_fileop.c        # 파일 작업 감시
├── informer_filenc.c        # 파일 이름 캐시
├── informer_registry.c      # 레지스트리 감시
├── informer_image.c         # 이미지 로드 감시
├── informer_object.c        # 객체 감시
├── informer_debug.c         # 디버그 Informer
├── comms.c                  # 필터 포트 통신 계층
├── comms_handlers.c         # 통신 핸들러
├── ringbuff.c               # 링 버퍼 (비동기 알림)
├── ratelmt.c                # 속도 제한
├── umaccess.c               # 사용자 모드 메모리 접근
├── kphthread.c              # 시스템 스레드 관리
├── protection.c             # 보호 메커니즘
├── cid_tracking.c           # CID 추적
├── verify.c                 # 검증
├── driver.c                 # 드라이버 진입점
└── KSystemInformer.vcxproj  # VS 프로젝트
```

### 3.4 phlib (핵심 라이브러리)

```
phlib/
├── include/                 # 공개 헤더
│   ├── ph.h                # 메인 헤더
│   ├── phbase.h            # 기본 타입/매크로
│   ├── phgui.h             # GUI 헤더
│   └── ...
├── native.c                 # Native API 래퍼
├── nativeprocess.c          # 프로세스 관리
├── nativethread.c           # 스레드 관리
├── nativetoken.c            # 토큰/권한
├── nativefile.c             # 파일 작업
├── guisup.c                 # GUI 지원
├── treenew.c                # 트리/리스트뷰
├── symprv.c                 # 심볼 공급자
├── util.c                   # 유틸리티
├── settings.c               # 설정 관리
├── json.c                   # JSON 파싱
├── http.c                   # HTTP 통신
└── phlib.vcxproj            # VS 프로젝트
```

### 3.5 Plugins (플러그인)

```
plugins/
├── include/                 # 플러그인 공유 헤더
├── DotNetTools/             # .NET 분석 도구
├── ExtendedTools/           # 확장 도구 (ETW, GPU)
├── HardwareDevices/         # 하드웨어 모니터링
├── NetworkTools/            # 네트워크 도구
├── ExtendedServices/        # 서비스 확장
├── ExtendedNotifications/   # 알림 확장
├── ToolStatus/              # 도구 모음 상태
├── OnlineChecks/            # 온라인 검사 (VirusTotal)
├── Updater/                 # 자동 업데이트
├── UserNotes/               # 사용자 주석
├── WindowExplorer/          # 윈도우 탐색기
└── Plugins.sln              # 플러그인 솔루션
```

---

## 4. 주요 모듈 설계

### 4.1 프로세스 관리 모듈

```
┌────────────────────────────────────────────────────────────┐
│                   프로세스 관리 모듈 구조                    │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐      ┌─────────────┐      ┌───────────┐  │
│  │ procprv.c   │─────►│ proctree.c  │─────►│ UI 렌더링 │  │
│  │ (Provider)  │      │ (Tree View) │      │           │  │
│  └──────┬──────┘      └─────────────┘      └───────────┘  │
│         │                                                  │
│         ▼                                                  │
│  ┌─────────────────────────────────────────────────┐      │
│  │              Native API Layer                    │      │
│  │  NtQuerySystemInformation / NtQueryProcess...   │      │
│  └──────────────────────┬──────────────────────────┘      │
│                         │                                  │
│                         ▼                                  │
│  ┌─────────────────────────────────────────────────┐      │
│  │           KSystemInformer Driver                 │      │
│  │    (확장 정보: 보호 상태, 토큰, 메모리 등)       │      │
│  └─────────────────────────────────────────────────┘      │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 4.2 플러그인 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                     Plugin Manager                          │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  plugman.c / plugin.c                  │ │
│  │  - 플러그인 검색 및 로드                               │ │
│  │  - 의존성 관리                                         │ │
│  │  - 콜백 등록                                           │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
    ┌───────────┐   ┌───────────┐   ┌───────────┐
    │ Plugin A  │   │ Plugin B  │   │ Plugin C  │
    │  (.dll)   │   │  (.dll)   │   │  (.dll)   │
    └───────────┘   └───────────┘   └───────────┘

    각 플러그인 필수 구현:
    - PhPluginGetInformation()  : 플러그인 정보 제공
    - DllMain()                 : DLL 진입점
```

### 4.3 커널 드라이버 통신 아키텍처

필터 포트(Filter Communication Port) 기반 통신 모델을 사용합니다.

```
┌──────────────────────────────────────────────────────────────┐
│                    User Mode (Ring 3)                        │
│                                                              │
│  ┌────────────────┐         ┌────────────────┐              │
│  │ SystemInformer │         │    kphlib      │              │
│  │    (Client)    │────────►│  (통신 라이브러리)│            │
│  └────────────────┘         └───────┬────────┘              │
│                                     │                        │
│                           Filter Port (FltConnectPort)       │
│                           + Ring Buffer (비동기 알림)         │
└─────────────────────────────────────┼────────────────────────┘
                                      │
══════════════════════════════════════╪════════════════════════
                                      │
┌─────────────────────────────────────┼────────────────────────┐
│                    Kernel Mode (Ring 0)                      │
│                                     ▼                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              KSystemInformer Driver                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ comms.c  │  │handlers.c│  │ verify.c │           │   │
│  │  │(필터포트)│  │(요청처리)│  │  (검증)  │           │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│  │  │ringbuff.c│  │ratelmt.c │  │umaccess.c│           │   │
│  │  │(링 버퍼) │  │(속도제한)│  │(UM 접근) │           │   │
│  │  └──────────┘  └──────────┘  └──────────┘           │   │
│  │                                                       │   │
│  │  ┌──────────────────────────────────────────────┐    │   │
│  │  │              Informer Modules                 │    │   │
│  │  │  Process | Thread | File | Registry | Image  │    │   │
│  │  │  Object  | Debug  | FileOp                   │    │   │
│  │  └──────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름

### 5.1 프로세스 정보 수집 흐름

```
1. 타이머 트리거 (1초 간격, 고해상도 모드 시 Timer2 사용)
        │
        ▼
2. PhEnumProcesses() 호출
        │
        ├──► NtQuerySystemInformation(SystemProcessInformation)
        │           │
        │           ▼
        │    프로세스 기본 정보 수집
        │
        ├──► KPH 드라이버 쿼리 (확장 정보)
        │           │
        │           ▼
        │    보호 상태, 서명 레벨 등
        │
        ▼
3. 프로세스 노드 업데이트
        │
        ▼
4. 델타 계산 (CPU, I/O, 메모리)
        │
        ▼
5. UI 트리뷰 업데이트
```

### 5.2 이벤트 처리 흐름

```
┌─────────────────┐
│   시스템 이벤트  │ (프로세스 생성, 파일 접근 등)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  KSystemInformer │ (커널 콜백 수신)
│   Informer      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  이벤트 큐잉    │ (필터링, 버퍼링)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  사용자 모드    │ (DeviceIoControl로 전달)
│  수신           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  콜백 실행      │ (등록된 콜백 호출)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   UI 업데이트   │
└─────────────────┘
```

---

## 6. 보안 아키텍처

### 6.1 드라이버 보안 계층

```
┌─────────────────────────────────────────────────────────────┐
│                      보안 검증 흐름                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 클라이언트 검증                                         │
│     ┌─────────────────────────────────────────────────┐    │
│     │  - 프로세스 서명 검증 (Authenticode)             │    │
│     │  - 이미지 무결성 확인                            │    │
│     │  - 신뢰할 수 있는 게시자 확인                    │    │
│     └─────────────────────────────────────────────────┘    │
│                            │                                │
│                            ▼                                │
│  2. 동적 데이터 검증                                        │
│     ┌─────────────────────────────────────────────────┐    │
│     │  - kphdyn.xml 서명 확인                          │    │
│     │  - Windows 버전별 오프셋 검증                    │    │
│     │  - 구조체 크기 유효성 검사                       │    │
│     └─────────────────────────────────────────────────┘    │
│                            │                                │
│                            ▼                                │
│  3. 요청 권한 검사                                          │
│     ┌─────────────────────────────────────────────────┐    │
│     │  - 클라이언트 권한 레벨 확인                     │    │
│     │  - 대상 프로세스 보호 상태 확인                  │    │
│     │  - 작업 허용 여부 결정                           │    │
│     └─────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 프로세스 보호 메커니즘

```
보호 레벨:
┌──────────────────────────────────────────────────────────┐
│ Level 3 (Max)  │  완전 보호 - 종료, 수정 불가            │
├──────────────────────────────────────────────────────────┤
│ Level 2        │  부분 보호 - 일부 작업 허용             │
├──────────────────────────────────────────────────────────┤
│ Level 1        │  기본 보호 - 대부분 작업 허용           │
├──────────────────────────────────────────────────────────┤
│ Level 0        │  보호 없음                              │
└──────────────────────────────────────────────────────────┘
```

---

## 7. 메모리 관리

### 7.1 참조 카운팅 시스템

```c
// phlib의 참조 카운팅 패턴
typedef struct _PH_OBJECT {
    PH_OBJECT_HEADER Header;
    // 객체 데이터
} PH_OBJECT;

// 참조 카운트 관리
PhReferenceObject(Object);    // 참조 증가
PhDereferenceObject(Object);  // 참조 감소 (0이면 해제)
```

### 7.2 메모리 풀 관리

```
┌─────────────────────────────────────────────────────┐
│                  메모리 풀 구조                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────┐   ┌─────────────┐                 │
│  │ Small Pool  │   │ Large Pool  │                 │
│  │ (< 256KB)   │   │ (>= 256KB)  │                 │
│  └──────┬──────┘   └──────┬──────┘                 │
│         │                 │                         │
│         ▼                 ▼                         │
│  ┌─────────────────────────────────────────┐       │
│  │          Heap Manager (phlib)           │       │
│  │  - 캐시된 할당/해제                      │       │
│  │  - 디버그 모드 추적                      │       │
│  └─────────────────────────────────────────┘       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 8. 스레드 및 동기화

### 8.1 동기화 프리미티브

| 프리미티브 | 용도 | 구현 |
|-----------|------|------|
| Queued Lock | 경량 잠금 | `PH_QUEUED_LOCK` |
| Init Once | 일회성 초기화 | `PH_INITONCE` |
| Rundown Protection | 안전한 해제 | `EX_RUNDOWN_REF` |
| Push Lock | 커널 잠금 | `EX_PUSH_LOCK` |

### 8.2 작업 스레드 모델

```
┌─────────────────────────────────────────────────────┐
│                 작업 큐 시스템                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  Main Thread          Worker Threads                │
│  ┌─────────┐         ┌─────────────────┐           │
│  │ UI Loop │────────►│ Thread Pool     │           │
│  └─────────┘         │  - I/O 작업     │           │
│                      │  - 네트워크     │           │
│                      │  - 파일 작업    │           │
│                      └─────────────────┘           │
│                                                     │
│  Provider Threads                                   │
│  ┌─────────────────────────────────────────┐       │
│  │ Process | Thread | Handle | Network     │       │
│  │ (주기적 갱신 스레드)                     │       │
│  └─────────────────────────────────────────┘       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 9. 확장성 설계

### 9.1 플러그인 확장점

```
┌────────────────────────────────────────────────────────────┐
│                    확장 가능한 지점                         │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  • 메인 메뉴 확장                                          │
│  • 컨텍스트 메뉴 확장                                      │
│  • 프로세스 속성 페이지 추가                               │
│  • 서비스 속성 페이지 추가                                 │
│  • 컬럼 추가 (프로세스, 스레드, 핸들 등)                   │
│  • 정보 제공자 등록                                        │
│  • 이벤트 콜백 등록                                        │
│  • 필터 추가                                               │
│  • 도구 모음 버튼 추가                                     │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 9.2 콜백 시스템

```c
// 콜백 등록 예제
typedef struct _PH_PLUGIN_CALLBACKS {
    PPH_CALLBACK ProcessAdded;
    PPH_CALLBACK ProcessDeleted;
    PPH_CALLBACK ProcessHighlighting;
    PPH_CALLBACK TreeNewMessage;
    PPH_CALLBACK MenuItemExecute;
    // ...
} PH_PLUGIN_CALLBACKS;
```

---

## 10. 프로젝트 통계

| 항목 | 수치 |
|------|------|
| 총 소스 파일 수 | 864개 |
| C 파일 | 504개 |
| C++ 파일 | 25개 |
| 헤더 파일 | 335개 |
| 총 코드 라인 | 940,000+ 라인 |
| 플러그인 수 | 11개 |
| 지원 Windows 버전 | 40+ |

---

## 부록: 주요 파일 참조

### 핵심 소스 파일 (코드 라인 기준)

| 파일 | 위치 | 라인 수 | 설명 |
|------|------|---------|------|
| util.c | phlib/ | 308K | 범용 유틸리티 |
| treenew.c | phlib/ | 279K | 트리/리스트뷰 |
| proctree.c | SystemInformer/ | 244K | 프로세스 트리 |
| native.c | phlib/ | 242K | Native API |
| tokprp.c | SystemInformer/ | 244K | 토큰 속성 |
| actions.c | SystemInformer/ | 199K | 프로세스 작업 |
| mapimg.c | phlib/ | 181K | PE 이미지 매핑 |
| mainwnd.c | SystemInformer/ | 175K | 메인 윈도우 |
| devprv.c | SystemInformer/ | 173K | 디바이스 공급자 |
| guisup.c | phlib/ | 170K | GUI 지원 |
