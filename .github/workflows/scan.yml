name: 'CodeQL Analysis'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  analyze_driver:
    name: analyze-driver
    runs-on: windows-2025
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ['cpp']
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
        with:
          fetch-depth: 0

      - name: Nuget Cache
        uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # 5.0.0
        with:
          path: packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.config') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Nuget Restore
        shell: cmd
        run: nuget restore .\packages.config -PackagesDirectory .\packages\

      - name: Build Tools
        shell: cmd
        run: build\build_tools.cmd

      - name: Initialize CodeQL
        uses: github/codeql-action/init@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
        with:
          languages: ${{ matrix.language }}

      - name: Build Driver
        shell: cmd
        run: build\build_zdriver.cmd

      - name: Finalize CodeQL Database
        run: |
          $codeqlPath = (Get-ChildItem -Path "$env:RUNNER_TOOL_CACHE\CodeQL" -Recurse -Filter "codeql.exe" | Select-Object -First 1).FullName
          & $codeqlPath database finalize "${{ runner.temp }}\codeql_databases\cpp"

      - name: Download Windows Driver Query Packs
        shell: pwsh
        run: |
          $codeqlPath = (Get-ChildItem -Path "$env:RUNNER_TOOL_CACHE\CodeQL" -Recurse -Filter "codeql.exe" | Select-Object -First 1).FullName
          & $codeqlPath pack download microsoft/windows-drivers@1.8.2
          & $codeqlPath pack download microsoft/cpp-queries@0.0.4

      - name: Run Windows Driver Analysis
        shell: pwsh
        run: |
          $codeqlPath = (Get-ChildItem -Path "$env:RUNNER_TOOL_CACHE\CodeQL" -Recurse -Filter "codeql.exe" | Select-Object -First 1).FullName
          $sarifOut = Join-Path "${{ runner.temp }}" "driver-analysis.sarif"
          & $codeqlPath database analyze "${{ runner.temp }}\codeql_databases\cpp" microsoft/windows-drivers --format=sarifv2.1.0 --output=$sarifOut
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Filter CodeQL Results
        uses: advanced-security/filter-sarif@f3b8118a9349d88f7b1c0c488476411145b6270d # 1.0.1
        with:
          input: ${{ runner.temp }}\driver-analysis.sarif
          output: ${{ runner.temp }}\driver-filtered.sarif
          patterns: packages/**

      - name: Upload CodeQL Results
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
        with:
          sarif_file: ${{ runner.temp }}\driver-filtered.sarif

  analyze_library:
    name: analyze-software
    runs-on: windows-2025
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['cpp']
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
        with:
          fetch-depth: 0

      - name: Nuget Cache
        uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # 5.0.0
        with:
          path: packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.config') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Nuget Restore
        shell: cmd
        run: nuget restore .\packages.config -PackagesDirectory .\packages\

      - name: Build Init
        shell: cmd
        run: build\build_init.cmd

      - name: Initialize CodeQL
        uses: github/codeql-action/init@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
        with:
          languages: ${{ matrix.language }}

      - name: Build Driver
        shell: cmd
        run: build\build_zdriver.cmd

      - name: Build Release
        shell: cmd
        run: build\build_release.cmd

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
        with:
          category: '/language:${{ matrix.language }}'
          output: sarif-results
          upload: never

      - name: Filter CodeQL Results
        uses: advanced-security/filter-sarif@f3b8118a9349d88f7b1c0c488476411145b6270d # 1.0.1
        with:
          input: sarif-results/cpp.sarif
          output: sarif-results/filtered.sarif
          patterns: |
            packages/**/*
            tools/CustomBuildTool/generated/**/*
            tools/CustomBuildTool/obj/**/*
            tools/thirdparty/**/*

      - name: Upload CodeQL Results
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
        with:
          sarif_file: sarif-results/filtered.sarif

  analyze_csharp:
     name: analyze-tools
     runs-on: windows-2025
     permissions:
       actions: read
       contents: read
       security-events: write
     strategy:
       fail-fast: false
       matrix:
         language: ['csharp']
     steps:
       - name: Checkout repository
         uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # 6.0.1
         with:
           fetch-depth: 0

       - name: Nuget Cache
         uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # 5.0.0
         with:
           path: packages
           key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.config') }}
           restore-keys: nuget-${{ runner.os }}-

       - name: Nuget Restore
         shell: cmd
         run: nuget restore .\packages.config -PackagesDirectory .\packages\

       - name: Initialize CodeQL
         uses: github/codeql-action/init@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
         with:
           languages: ${{ matrix.language }}

       - name: Build Tools
         shell: cmd
         run: build\build_tools.cmd

       - name: Perform CodeQL analysis
         uses: github/codeql-action/analyze@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
         with:
           category: '/language:${{ matrix.language }}'
           output: sarif-results
           upload: never

       - name: Filter CodeQL Results
         uses: advanced-security/filter-sarif@f3b8118a9349d88f7b1c0c488476411145b6270d # 1.0.1
         with:
           input: sarif-results/csharp.sarif
           output: sarif-results/filtered.sarif
           patterns: |
             packages/**/*
             tools/CustomBuildTool/generated/**/*
             tools/CustomBuildTool/obj/**/*
             tools/thirdparty/**/*

       - name: Upload CodeQL Results
         uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # 4.31.7
         with:
           sarif_file: sarif-results/filtered.sarif
